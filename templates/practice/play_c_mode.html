<!-- templates/practice/play_c_mode.html -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>å£è¯´ç»ƒä¹ æ¨¡å¼ï¼ˆCï¼‰</h2>

<div id="player-area">
  <p id="material-text">{{ material.question_text }}</p>
  <audio id="audio" controls src="{{ material.audio.url }}"></audio>
</div>

<button id="start-record">ğŸ¤ å¼€å§‹å½•éŸ³</button>
<button id="stop-record" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>

<p>è¯†åˆ«ç»“æœï¼š<span id="result-{{ material.id }}"></span></p>

<script>
let mediaRecorder;
let audioChunks = [];

const startButton = document.getElementById("start-record");
const stopButton = document.getElementById("stop-record");

startButton.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
    };

    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        uploadAudio(audioBlob, {{ session.id }}, {{ material.id }});
    };

    mediaRecorder.start();
    startButton.disabled = true;
    stopButton.disabled = false;
};

stopButton.onclick = () => {
    mediaRecorder.stop();
    startButton.disabled = false;
    stopButton.disabled = true;
};

function uploadAudio(blob, sessionId, materialId) {
    const formData = new FormData();
    formData.append("audio", blob);

    fetch(`/oral/submit/${sessionId}/${materialId}/`, {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`result-${materialId}`).innerText = data.recognized_text;
        if (data.is_correct) {
            alert("âœ… æ­£ç¡®ï¼");
        } else {
            alert("âŒ å†è¯•ä¸€æ¬¡ï¼");
        }
    });
}
</script>
{% endblock %}
